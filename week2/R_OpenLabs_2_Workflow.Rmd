---
title: ""
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R Open Labs
## Introduction
#### University of North Carolina at Chapel Hill
#### Nuvan Rathnayaka
#### September 20, 2018

## Data and other downloads
[Airbnb listings from Washington DC ](http://guides.lib.unc.edu/ld.php?content_id=40263741)


##Today

This introductory workshop aims to cover:

* Reproducible workflow
    + importing data
    + scripts
    + projects
    + saving output
* [R for Data Science Chapters 4,6,8](http://r4ds.had.co.nz/workflow-basics.html)

## What is reproducibility?

1. Scientific reproducibility - if you repeat my experiment, you will get the same results as me. This is beyond the scope of this workshop ([see here for an overview](https://en.wikipedia.org/wiki/Replication_crisis))

2. Computational reproducibility - if I give you my data and code, you will get the same results as me. This is what we'll focus on today

## Why does computational reproducibility matter?

1. Your most important collaborator is you six months from now.
2. We want Science (with a capital S) to be self-correcting. Since you're human, you will make mistakes, so you want to make it as easy as possible for others to catch your errors (see [the Reinhart and Rogoff Excel error](https://theconversation.com/the-reinhart-rogoff-error-or-how-not-to-excel-at-economics-13646) and [the Guinea worm wars](https://www.cgdev.org/blog/mapping-worm-wars-what-public-should-take-away-scientific-debate-about-mass-deworming) for recent examples)



## Your script is real, your environment is not

For your results to be reproducible, every step you take to manipulate the data should be explicitly documented in an R script.

This also means that you want to make sure that your results don't hidden/implicit dependencies on your R environment. There are two steps you can to take to prevent this.

1. Reconfigure RStudio not to save your workspace between sessions.
![](figures/rstudio-workspace.png)

2. Restart RStudio from scratch and rerun the current script often.
    + Cmd/Ctrl + Shift + F10 to restart RStudio
    + Cmd/Ctrl + Shift + S to rerun the current script

Note: If you have learned R in the past, you may have been taught to use the expression rm(list = ls()) to clear your R environment. [This will not actually return R to a blank slate!](https://community.rstudio.com/t/first-line-of-every-r-script/799/12) Although this code will delete objects in your R environment, it won't reset global settings that have been changed. It is always safer and more effective to restart RStudio.

## RStudio Projects

You can use the R function setwd() to point to locations of data files, but this isn't ideal for reproducible research. When you switch between computers, it is likely that the **absolute** directory path will change, so you will have to modify the path for each computer. Users of your code will not have the same absolute directory path that you have, so they will have to modify the path in the setwd() function before they can use your code.

RStudio Projects provide a way to bundle together data, code, and other files together so that you can refer to files with **relative** directory paths, which creates a much more portable structure that won't need to be modified between computers or users.

## Airbnb Data Analysis 1: Configuring the RStudio project

1. File > New Project > New Directory > New Project
2. Create a new subdirectory inside this project to store the data
3. Copy the Airbnb data (listings.csv) into this data directory
4. Create a new R Script for the data analysis in this project.

## Comments are your friend

In R, the # symbol indicates the beginning of a comment. Everything to the right of that is ignored by R, so you can write plain text to document what you're doing, organize your code, and explain any tricky or unusual steps.

## Airbnb Data Analysis 2: Import the data

We'll begin by loading the **tidyverse** library. This library includes **readr**, which we will use to read in our data file (for more details on readr, see Chapter 11 of the text).

RStudio has a useful keyboard shortcut for **<-** (the assignment operator): Alt+-, that is press the Alt key and the minus key at the same time.

```{r import}
# Purpose: Exploratory data analysis of airbnb data
# Author: Nuvan Rathnayaka
# Date: September 2018

# Setup -----------------------------------------------------------
library(tidyverse)

# Data Import ------------------------------------------------------
airbnb_dc <- read_csv("data/listings.csv") #Since I'm using an RStudio project, I only have to specify the path relative to the top directory

```

## Aside on coding conventions
Something that I've glossed over is that you have options for how to name objects. For example, we called our imported data **airbnb_dc**, but we could have called it **airbnbListings**, or **airbnb.listings**

Having a consistent way you name objects and functions helps you remember what things are called. It's especially useful when you're working with others to agree upon a coding convention. There are many coding conventions you could choose. It doesn't particularly matter which one you choose, as long as you choose a convention and stick to it.

To be consistent with the text, we will stick to the Tidyverse style guide:
http://style.tidyverse.org/index.html

## Airbnb Data Analysis 3: Some useful commands
The dim() function will print the dimensions (rows x columns) of your data frame.

head() will print the first few rows of your data frame.

str() is a very general purpose function that will display the structure of an object. This is especially useful for debugging.

```{r useful}
# Some useful functions  ----------------------------------------
dim(airbnb_dc)
head(airbnb_dc)
str(airbnb_dc)

```

## Airbnb Data Analysis 4: Tables for categorical data
We can use the table() function to view counts/frequencies of categorical variables.

```{r tables}
# Categorical Variables  ----------------------------------------
table(airbnb_dc$property_type)
```

As we saw in week 1, you can also next functions within each other. Here, let's generate a contingency table using table(), then sort it by count using sort().

```{r table2}
sort(table(airbnb_dc$property_type), decreasing=TRUE)
```
That works, but it's a little hard to read. We could try breaking this into two steps and storing our intermediate output.

```{r table3}
property_type_table <- table(airbnb_dc$property_type)
sort(property_type_table, decreasing = TRUE)
```

This works ok, but it does mean we're creating an additional object, property_type_table, and we could end up with lots of objects that are trivially different from each other if we do this too often. In the next lesson, we'll introduce the pipe operator, which makes this kind of nested computation easier to read.

Last week talked about different kinds of vectors. Recall, a vector is a column of data of a single type, and a data frame is a collection of vectors of the same length. Last week we introduced integer, numeric, character, and factor vectors. There's another commonly used vector type: logical. This is just a vector of TRUE or FALSE values. Suppose we want to know whether a listings price is greater than 500.

```{r logical}
airbnb_dc$price > 500 #Note that since we're not assigning this vector to a variable, R displays it, but doesn't save it as an object in the environment.
```

You can see other logical operators [here](https://www.statmethods.net/management/operators.html).

We can feed this logical vector into the table() function to get a count of how many listings have prices above $500.
```{r table4}
table(airbnb_dc$price > 500)
```

We can also use the table function to look at the joint counts of multiple categorical variables. For example, if we want to look at the how many properties have prices above $500 across different property types.

```{r table5}
with(airbnb_dc, table(property_type, price > 500))
```

## Airbnb Data Analysis 5: Exploring continuous data
R has built-in functions to compute the mean, standard deviation, min, median, and max.

```{r continuous1}
# Continuous Variables  ----------------------------------------

mean(airbnb_dc$price)
sd(airbnb_dc$price)
min(airbnb_dc$price)

median(airbnb_dc$price)

max(airbnb_dc$price)

```

R also has a built-in function to compute correlation coefficients. By default, it computes the Pearson correlation

```{r correlation}

with(airbnb_dc, cor(price, number_of_reviews))

```

## Missing Data

There are some missing values in the review_scores_rating and reviews_per_month columns, even within the first six rows. We can check which values of review_scores_rating are NA with is.na()

```{r missing}
# Continuous Variables  ----------------------------------------


sum(is.na(airbnb_dc$review_scores_rating)) #summing a logical (TRUE/FALSE) vector counts the number of TRUE values



```

We can check all of our columns using R's colSum to sum all of the columns at the same time.

```{r missing data2}

colSums(is.na(airbnb_dc))

```

Handling missing data is an advanced topic that is a bit beyond the scope of this lesson. There is no good way to handle missing data, there are only bad and less bad ways. 

One of the bad ways to handle missing data is what's known as a complete case analysis. In this kind of analysis, you only keep observations (rows) where you have observed (non-missing) values for ALL columns. 

R has built-in functions to facilitate this:
* `complete.cases` returns a logical vector indicating whether or not an entire row of a dataset contains any missing values.  You can also use this function on a subset of columns to determine if only those columns are complete
* `na.omit` returns a new dataframe with only the complete cases (as identified above)

For most R functions, the default is to return NA is any of the values are NA:
```{r mean}
mean(airbnb_dc$review_scores_rating)
with(airbnb_dc, cor(review_scores_rating, reviews_per_month))
```

Some functions, like the linear regression function lm(), perform a complete-case analysis:

```{r lm}

lm(review_scores_rating~price, data=airbnb_dc)
```

When a function complains about missing values and fails, there usually an argument that can be modified to change it to a complete-case analysis:

```{r mean2}
mean(airbnb_dc$review_scores_rating, na.rm=TRUE)
with(airbnb_dc, cor(review_scores_rating, reviews_per_month, use="pairwise.complete.obs"))
```


Complete-case analysis is OK for exploratory data analysis, but if your goal is statistical inference, you'll want to use a different method (e.g. multiple imputation using the mice library)

## Additional resources for reproducible workflow

[Why setwd() is bad practice](https://www.tidyverse.org/articles/2017/12/workflow-vs-script/)

[Concise guide to basic computational reproducibility](https://kbroman.org/steps2rr/)

[Eight things you can do to make your open science more understandable](http://datacolada.org/69)

[A detailed guide to reproducible workflows in collaborative settings](http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005510)

[For more complicated projects, consider using make and docker](http://www.jonzelner.net/statistics/make/docker/reproducibility/2016/05/31/reproducibility-pt-1/)


## Exercises

1. What are the different types of cancellation policies offered at Airbnb?
2. What is the most common and least common cancellation policy?
3. What percent of Airbnb property types are houses? Hint: To find what percent of X is Y, use this formula: Y/X * 100
4. How many listings get a review rating below 50?
5. Try installing the visdat library, and explore different ways to visualize missing data.


## Feedback
[Let us know what you think of this lesson!](https://unc.az1.qualtrics.com/jfe/form/SV_8e1zRY2rlFUYBMx)